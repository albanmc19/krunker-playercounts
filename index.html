<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Joueurs connectés sur Krunker.io</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>
  <h1>Joueurs connectés sur Krunker.io :</h1>
  <div id="playerCount">Chargement...</div>
  
  <div class="chart-container">
    <canvas id="playerChart"></canvas>
  </div>

  <div class="controls">
    <button onclick="changeInterval('30min')">30 minutes</button>
    <button onclick="changeInterval('1hour')">1 heure</button>
    <button onclick="changeInterval('1day')">1 jour</button>
    <button onclick="changeInterval('all')">Tout l'historique</button>
  </div>

  <script>
    let allPlayerData = {
      labels: [],
      counts: []
    };
    let filteredData = {
      labels: [],
      counts: []
    };
    let currentInterval = '30min';
    let chart;
    
    function loadData() {
      const savedData = localStorage.getItem('krunkerPlayerData');
      if (savedData) {
        allPlayerData = JSON.parse(savedData);
      }
    }

    function initChart() {
      const ctx = document.getElementById('playerChart').getContext('2d');
      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: filteredData.labels,
          datasets: [{
            label: 'Nombre de joueurs',
            data: filteredData.counts,
            backgroundColor: 'rgba(76, 175, 80, 0.5)',
            borderColor: 'rgba(76, 175, 80, 1)',
            borderWidth: 1
          }]
        },
        options: {
          indexAxis: 'y',
          responsive: true,
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Temps'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Nombre de joueurs'
              }
            }
          },
          plugins: {
            title: {
              display: filteredData.labels.length === 0,
              text: filteredData.labels.length === 0 ? 'Aucune donnée à afficher' : ''
            }
          }
        }
      });
    }

    function updateChart() {
      if (filteredData.labels.length === 0) {
        chart.options.plugins.title.display = true;
        chart.options.plugins.title.text = 'Aucune donnée à afficher';
      } else {
        chart.options.plugins.title.display = false;
        chart.options.plugins.title.text = '';
      }
      chart.data.labels = filteredData.labels;
      chart.data.datasets[0].data = filteredData.counts;
      chart.update();
    }

    function addDataPoint(count) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString() + ' ' + now.toLocaleDateString();
      allPlayerData.labels.push(timeStr);
      allPlayerData.counts.push(count);
      saveData();
      filterDataByInterval();
      updateChart();
    }

    function filterDataByInterval() {
      const now = new Date();
      let cutoffTime;
      filteredData = { labels: [], counts: [] };
      for (let i = 0; i < allPlayerData.labels.length; i++) {
        const dataTime = new Date(allPlayerData.labels[i]);
        let keep = false;
        switch(currentInterval) {
          case '30min':
            cutoffTime = new Date(now.getTime() - 30 * 60 * 1000);
            keep = dataTime >= cutoffTime;
            break;
          case '1hour':
            cutoffTime = new Date(now.getTime() - 60 * 60 * 1000);
            keep = dataTime >= cutoffTime;
            break;
          case '1day':
            cutoffTime = new Date(now.getTime() - 24 * 60 * 60 * 1000);
            keep = dataTime >= cutoffTime;
            break;
          case 'all':
            keep = true;
            break;
        }
        if (keep) {
          filteredData.labels.push(allPlayerData.labels[i]);
          filteredData.counts.push(allPlayerData.counts[i]);
        }
      }
    }

    function changeInterval(interval) {
      currentInterval = interval;
      filterDataByInterval();
      updateChart();
    }

    async function fetchPlayerCount() {
      try {
        const response = await fetch('/playercount');
        const data = await response.json();
        document.getElementById('playerCount').textContent = data.playerCount;
        addDataPoint(data.playerCount);
      } catch (e) {
        document.getElementById('playerCount').textContent = "Erreur de chargement";
      }
    }

    // Initialisation
    loadData();
    filterDataByInterval();
    initChart();
    fetchPlayerCount();
    setInterval(fetchPlayerCount, 10000);
  </script>
</body>
</html>
